\startmode[presentation]
  \setuppapersize[S6][S6]
  \setuplayout[
    topspace=5pt,
    backspace=20pt,
    width=middle,
    height=middle,
    header=0pt,
    footer=14pt,
    footerdistance=3pt,
    bottomspace=1pt
  ]
  \setupcolors[state=start]
  \setuppagenumber[state=stop]

  \setupbackgrounds[page][background=color, backgroundcolor=white]
  
  \usemodule[simplefonts]
  \setmainfont[Source Sans Pro]

  \define[1]\SlideTitle{
    \midaligned{ \tfb #1 }
    \blank[line]
  }

  % Slide macros
  \def\startSlide{\directsetup{slide:start}}
  \def\stopSlide{\directsetup{slide:stop}}

  \startsetups slide:start
    \start
    \switchtobodyfont[24pt]
    \dontleavehmode
  \stopsetups

  \startsetups slide:stop
    \page
    \stop
  \stopsetups

  \setupfootertexts[][@AllanEspinosa]
\stopmode

\startmode[manuscript]

  \setupframedtexts[location=middle, before={\blank[line]},
                    after={\blank[line]}]
  \let\startSlide\startframedtext
  \let\stopSlide\stopframedtext

  \define[1]\SlideTitle{\midaligned{\bf #1}\blank[small]}
\stopmode

\def\startNote{\startmode[manuscript]}

\starttext

\startSlide
\setupfooter[state=stop]
\vfill
\SlideTitle{Autoscaling Containers\ldots with Math}
\midaligned{ @AllanEspinosa }
\vfill
\stopSlide

\startSlide
\vfill
\midaligned{ \externalfigure[https://images-na.ssl-images-amazon.com/images/I/51xkdqGcykL.jpg][width=0.55\textwidth] }
\vfill
\stopSlide

\startSlide

\vfill

\dontleavehmode
\externalfigure[https://www.engineyard.com/images/company/presskit/EY_Logotype_red.png][width=0.4\textwidth]
\hfill
\externalfigure[logo.svg][width=0.4\textwidth]

\vfill

\stopSlide

\startSlide

\SlideTitle{Your Distributed System}

\tfxx
\startMPcode

.PS

arrowht = 0.2
arrowwid = 0.1
linethick = 2
linewid = 1.0

"Goal" at Here rjust
line right ->

ellipse "OPS Person" wid 1.3 ht 0.7

line right -> "Twiddle" above

box "Server Farm" wid 1.3 ht 0.7

line right 2 "CPU Utilization" above ->

line from last line.c down 1.5 then left ->

box "Monitoring" wid 1.3 ht 0.7

line from Here to (1st ellipse.s.x, Here.y) then up to 1st ellipse.s -> "Page" ljust

line from 1st box.n up <-
"Traffic" at Here above


.PE

\stopMPcode

\stopSlide

\startNote
Receive load, 

monitoring system receives performance metrics. Depending on the thresholds you
set in Nagios, you get paged. 

You wake up at 2am. SSH to instances (*gasp!*) or update your Chef environment
attributes. Converge chef. Check if alerts clear.

Then finally go to sleep.

Dynamics where in the state of our system evolves and changes over time due to
several factors.
\stopmode

\startSlide

\SlideTitle{Your Aircon}

\tfxx
\startMPcode

.PS

arrowht = 0.2
arrowwid = 0.1
linethick = 2
linewid = 1.0

line right "Set Temperature" above rjust ->

ellipse "Thermostat" wid 1.3 ht 0.7

line right -> "Valve" above

box "Coolant" wid 1.3 ht 0.7

line right 2 "Actual Temperature" above ->

line from last line.c down 1.5 then left ->

box "Sensor" wid 1.3 ht 0.7

line from Here to (1st ellipse.s.x, Here.y) then up to 1st ellipse.s ->

line from 1st box.n up <-
"The Weather" at Here above


.PE

\stopMPcode
\stopSlide

\startNote
Notice how everything look the same. Except for an Ops person being woken up to
adjust the thermostat.

You may have to wake up if you didn't set the thermostat properly. But that's a
different problem for now.

{ \em detect } changes in the environment and { \em respond } to them.
\stopmode

\startSlide
\vfill
\SlideTitle{Support questions}
\startitemize
\item How many unicorn workers should I have?
\item Why is monit killing my sidekiq workers?
\stopitemize
\vfill
\stopSlide

\startNote

Applies to any parameter you set in your system. From nginx workers, maxClients,
etc.

I get these questions every so often
\stopmode

\startSlide
\midaligned{
\externalfigure[http://akamaicovers.oreilly.com/images/9780596518585/lrg.jpg][width=0.4\textwidth]
}

\stopSlide

\startNote
I want to slap them with this book!

Sometimes people tend to automate things they don't understand that produces
surprising results.  Slow response to change in workload, wild oscillations when 
a configuration is changed.

Typical support requests to just restart.  The book is great in that it gives
practical guidelines to conduct experiments to find out the effect of your
configuration setting in a safe manner, automated or not.

And to learn the effectiveness of our automation or any improvement in our
processes, we basically look at the feedback of the output/ results of what we
did. 
\stopmode

\startSlide

\SlideTitle{Control Theory}

\startitemize[columns]
  \item Target Output
  \item Input
  \item Output
  \item Disturbance
\stopitemize

\vfill

\tfxx
\startMPcode
.PS
arrowht = 0.2
arrowwid = 0.1
linethick = 2
linewid = 1.0

boxwid = 1.4
boxht = 1.0


"$r(k)$" at Here rjust
line right 0.5 -> "$+$" above ljust

circle rad 0.18

line right -> "$e(k)$" above

box "$K(z)$"

line right -> "$u(k)$" above

box "$G(z)$"

line right ->

"$y(k)$" at Here ljust

move to last line.c
line down boxht  then left (Here.x - 1st circle.s.x)

line -> to 1st circle.s "$-$" above ljust

line from last box.n up  <-
"$d(k)$" above


.PE
\stopMPcode
\vfill
\stopSlide

\startNote

Feedback control or control theory changes the approach in that the output is
the observed behavior. In this case, CPU utilization. The actual workload of
traffic affects the utilization but we can't do that much about it. You can't
stop people from buying thing in your shopping side. 

Feedback in a more general term is using what we learned so far and apply it to
the next iteration of our planning. The same goes with the discipline in control
theory.

We have a system where we control the input. Results in certain output. We then 
compare it to our desired output and then adjust the input we give to the
system.

In the example in OPS, we have an objective for our system like let's say
maintain 60\% CPU utilization.  Our system receives traffic and registers a
corresponding status of its current CPU utilization.  When some thresholds are
reached in our alerting system like Nagios or PagerDuty, we wake up at 2am.

We look at what's happening and then decide. Do we continue to sleep or do
something about it?  We can add instances.  Next we observe and wait for a while
before we finally go back to bed... And finally take the morning off at work.

Similar to our Thermostat controller as well.

In the next few slides, I will talk about several concepts in control theory
on what makes a good automation system.  We will look at the basic concept of
autoscaling in Kuberenetes.

Control theory has some math behind it to decide what makes a good feedback
loop.

\stopmode

\startSlide

\midaligned{
\externalfigure[https://upload.wikimedia.org/wikipedia/commons/1/1e/Centrifugal_governor.png][width=0.75\textwidth]
}

{\tfxx R. Routledge, {\em Discoveries \& Inventions of the Nineteenth Century}, 13th
edition, 1901. }

\stopSlide

\startSlide

\SlideTitle{Autoscaling}

{\tfxx
\startMPcode
.PS

arrowht = 0.2
arrowwid = 0.1
linethick = 2
linewid = 1.0

"Target" at Here rjust
line right 0.5 ->

ellipse "HPA" wid 1.3 ht 0.7

line right 2.0 -> "Number of Pods" above

box "RC" wid 1.3 ht 0.7

line right 2 "Utilization" above ->

line from last line.c down 1.5 then left ->

box "Heapster" wid 1.3 ht 0.7

line from Here to (1st ellipse.s.x, Here.y) then up to 1st ellipse.s -> "Utilization" ljust


line from 1st box.n up <-
"Traffic" at Here above


.PE

\stopMPcode
}

Autoscaling is a great example of feedback control.


Horizontal Pod Autoscaler

System output : current CPU utilization

System input: number of instances in the replication controller

Target output : desired CPU utilization

Details:
https://github.com/kubernetes/kubernetes/blob/release-1.2/docs/design/horizontal-pod-autoscaler.md#horizontalpodautoscaler-object
http://kubernetes.io/docs/user-guide/horizontal-pod-autoscaling/

\stopSlide

\startNote

Kubernetes has a basic facility for autoscaling Replicaton controller based on
CPU utilization.  It basically updates the number of instances of your container
based on the rules you set in the HPA API object.

\stopmode

\startSlide

Feedback Architecture

error

\stopSlide

\startSlide

Sample control regulation graph. disturbance rejection, etc.

Or Change in the target output

\stopSlide

\startSlide

Accuracy \hfill yyy 

\vfill

Stability \hfill xx

\stopSlide

\startmode[manuscript]

Accuracy - did we reach our desired CPU utilization? How much are we off?  Since
the workload is not fixed, we need a bit of wiggle room to consider our
autoscaling as good enough. Otherwise we will see oscillations of adding and
subtracting instances all the time.

\stopmode

\startSlide

Non-linearity

\stopSlide

\startSlide

\midaligned {
\framed[width=0.8\textwidth, frame=off]{
\dontleavehmode
\externalfigure[https://images-na.ssl-images-amazon.com/images/I/41iAmXZ8zbL.jpg][width=0.3\textwidth]
\hfill
\externalfigure[https://images-na.ssl-images-amazon.com/images/I/41Lg4IZz+nL.jpg][width=0.3\textwidth]
}
}

\stopSlide



\stoptext
